<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ‰¹é‡Canvasè£å‰ªå¤„ç†å™¨</title>
    <style>
        body { 
            font-family: -apple-system, BlinkMacSystemFont, sans-serif; 
            max-width: 1200px; 
            margin: 0 auto; 
            padding: 20px; 
            background: #f5f7fa; 
        }
        .processor-section { 
            background: white; 
            padding: 30px; 
            border-radius: 15px; 
            box-shadow: 0 5px 20px rgba(0,0,0,0.1); 
            margin: 20px 0;
        }
        .progress-bar { 
            width: 100%; 
            height: 20px; 
            background: #e9ecef; 
            border-radius: 10px; 
            overflow: hidden; 
            margin: 20px 0; 
        }
        .progress-fill { 
            height: 100%; 
            background: linear-gradient(135deg, #28a745, #20c997); 
            transition: width 0.3s ease; 
            width: 0%; 
        }
        .image-grid { 
            display: grid; 
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); 
            gap: 20px; 
            margin: 30px 0; 
        }
        .crop-item { 
            border: 1px solid #dee2e6; 
            border-radius: 10px; 
            padding: 15px; 
            background: #f8f9fa; 
        }
        .crop-preview { 
            display: flex; 
            gap: 10px; 
            align-items: center; 
        }
        .preview-canvas { 
            border: 1px solid #ccc; 
            border-radius: 5px; 
            max-width: 100px; 
            max-height: 100px; 
        }
        .crop-info { 
            flex: 1; 
            font-size: 0.9em; 
        }
        .status-badge { 
            padding: 4px 8px; 
            border-radius: 12px; 
            font-size: 0.8em; 
            font-weight: 600; 
        }
        .status-pending { background: #fff3cd; color: #856404; }
        .status-processing { background: #cce5ff; color: #0056b3; }
        .status-success { background: #d4edda; color: #155724; }
        .status-error { background: #f8d7da; color: #721c24; }
        .process-btn { 
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            border: none;
            padding: 15px 30px;
            border-radius: 25px;
            cursor: pointer;
            font-weight: 600;
            font-size: 1.1em;
            margin: 10px;
        }
        .process-btn:hover { transform: translateY(-2px); }
        .process-btn:disabled { opacity: 0.6; cursor: not-allowed; }
        h1 { text-align: center; color: #2c3e50; }
        .summary { text-align: center; color: #7f8c8d; margin-bottom: 30px; }
        .log-area { 
            background: #2c3e50; 
            color: #ecf0f1; 
            padding: 20px; 
            border-radius: 10px; 
            font-family: 'Courier New', monospace; 
            font-size: 0.9em;
            max-height: 300px;
            overflow-y: auto;
            margin: 20px 0;
        }
        .download-all { 
            background: linear-gradient(135deg, #28a745, #20c997);
            margin-top: 20px;
        }
    </style>
</head>
<body>
    <h1>ğŸ¨ Canvasæ‰¹é‡è£å‰ªå¤„ç†å™¨ v1.0</h1>
    <p class="summary">å¯¹20å¼ çœŸå®å›¾ç‰‡æ‰§è¡ŒCanvasè£å‰ªï¼Œç”Ÿæˆæ ‡å‡†åŒ–çš„è£å‰ªç»“æœ</p>

    <div class="processor-section">
        <h2>ğŸ“Š å¤„ç†è¿›åº¦</h2>
        <div class="progress-bar">
            <div class="progress-fill" id="progress-fill"></div>
        </div>
        <p id="progress-text">å‡†å¤‡å¼€å§‹å¤„ç†...</p>
        
        <div style="text-align: center; margin: 20px 0;">
            <button class="process-btn" onclick="startBatchProcessing()" id="start-btn">
                ğŸš€ å¼€å§‹æ‰¹é‡è£å‰ªå¤„ç†
            </button>
            <button class="process-btn download-all" onclick="downloadAllResults()" id="download-btn" disabled>
                ğŸ“¦ æ‰¹é‡ä¸‹è½½è£å‰ªç»“æœ
            </button>
        </div>
    </div>

    <div class="processor-section">
        <h2>ğŸ“‹ å¤„ç†æ—¥å¿—</h2>
        <div class="log-area" id="log-area"></div>
    </div>

    <div class="processor-section">
        <h2>ğŸ–¼ï¸ è£å‰ªç»“æœé¢„è§ˆ</h2>
        <div class="image-grid" id="results-grid"></div>
    </div>

    <script>
        // çœŸå®å›¾ç‰‡é…ç½®
        const imageConfigs = [
            { file: '514395460_793592689837250_6716909223341968659_n.jpg', scene: 'instagram-story', target: [1080, 1920] },
            { file: '520223512_796639402865912_9122114948815406813_n.jpg', scene: 'instagram-post', target: [1080, 1080] },
            { file: '538783140_1081667070741721_7590305933866675938_n.jpg', scene: 'twitter-avatar', target: [400, 400] },
            { file: '539123735_1081667597408335_3672692203658739325_n.jpg', scene: 'linkedin-avatar', target: [400, 400] },
            { file: '539357730_1081667514075010_543704824412561690_n.jpg', scene: 'wechat-avatar', target: [640, 640] },
            { file: '540953364_122176180070368444_9122116863782221520_n.jpg', scene: 'youtube-thumbnail', target: [1280, 720] },
            { file: '542005975_1122090326528798_291751363339586782_n.jpg', scene: 'facebook-cover', target: [1200, 630] },
            { file: '543093328_24879514531655303_4393783564674959693_n.jpg', scene: 'instagram-post', target: [1080, 1080] },
            { file: '543101382_1122090503195447_8591081234852726439_n.jpg', scene: 'tiktok', target: [1080, 1920] },
            { file: '544561870_1122090333195464_4150693688071878958_n.jpg', scene: 'instagram-story', target: [1080, 1920] },
            { file: '545137503_802726098939073_344329420305544671_n.jpg', scene: 'youtube-thumbnail', target: [1280, 720] },
            { file: '546376419_10238747466974444_8476391214317887945_n.jpg', scene: 'facebook-cover', target: [1200, 630] },
            { file: '546381431_122246413436160613_3708853180197877791_n.jpg', scene: 'twitter-avatar', target: [400, 400] },
            { file: '547011755_10163991416035555_2798119668148624268_n.jpg', scene: 'linkedin-avatar', target: [400, 400] },
            { file: '547103047_122273456876179587_8064148281068749731_n.jpg', scene: 'instagram-post', target: [1080, 1080] },
            { file: '547268409_24597330353231524_2816715975986438217_n.jpg', scene: 'wechat-avatar', target: [640, 640] },
            { file: 'can-someone-crop-enhance-this-photo-please-v0-uxa5314y46of1.webp', scene: 'tiktok', target: [1080, 1920] },
            { file: 'does-this-photo-need-a-crop-v0-nlfjhkycpl7e1.webp', scene: 'instagram-story', target: [1080, 1920] },
            { file: 'how-to-crop-v0-ihrntc6z2v6f1.webp', scene: 'youtube-thumbnail', target: [1280, 720] },
            { file: 'yq3jq65les8e1.webp', scene: 'twitter-avatar', target: [400, 400] }
        ];

        let processedResults = [];
        let currentProcessing = 0;

        // æ—¥å¿—å‡½æ•°
        function log(message, type = 'info') {
            const logArea = document.getElementById('log-area');
            const timestamp = new Date().toLocaleTimeString();
            const icon = type === 'error' ? 'âŒ' : type === 'success' ? 'âœ…' : type === 'processing' ? 'ğŸ”„' : 'â„¹ï¸';
            
            logArea.innerHTML += `[${timestamp}] ${icon} ${message}\n`;
            logArea.scrollTop = logArea.scrollHeight;
            
            console.log(`[${timestamp}] ${message}`);
        }

        // æ›´æ–°è¿›åº¦
        function updateProgress(current, total) {
            const percentage = (current / total) * 100;
            document.getElementById('progress-fill').style.width = `${percentage}%`;
            document.getElementById('progress-text').textContent = 
                `å¤„ç†è¿›åº¦: ${current}/${total} (${Math.round(percentage)}%)`;
        }

        // è®¡ç®—æ™ºèƒ½è£å‰ªå‚æ•°
        function calculateSmartCrop(originalWidth, originalHeight, targetWidth, targetHeight) {
            const originalRatio = originalWidth / originalHeight;
            const targetRatio = targetWidth / targetHeight;
            
            let cropX = 0, cropY = 0, cropWidth = originalWidth, cropHeight = originalHeight;
            
            if (originalRatio > targetRatio) {
                // åŸå›¾æ›´å®½ï¼Œéœ€è¦è£å‰ªå·¦å³
                cropWidth = Math.floor(originalHeight * targetRatio);
                cropX = Math.floor((originalWidth - cropWidth) / 2);
            } else {
                // åŸå›¾æ›´é«˜ï¼Œéœ€è¦è£å‰ªä¸Šä¸‹
                cropHeight = Math.floor(originalWidth / targetRatio);
                cropY = Math.floor((originalHeight - cropHeight) / 2);
            }
            
            return { x: cropX, y: cropY, width: cropWidth, height: cropHeight };
        }

        // å¤„ç†å•å¼ å›¾ç‰‡
        async function processSingleImage(config, index) {
            log(`å¼€å§‹å¤„ç†å›¾ç‰‡ ${index + 1}: ${config.file}`, 'processing');
            
            try {
                // 1. åŠ è½½åŸå›¾
                const response = await fetch(`test_results/original_images/${config.file}`);
                if (!response.ok) {
                    throw new Error(`åŠ è½½å¤±è´¥: HTTP ${response.status}`);
                }
                const blob = await response.blob();
                
                // 2. åˆ›å»ºImageå¯¹è±¡
                const img = new Image();
                await new Promise((resolve, reject) => {
                    img.onload = resolve;
                    img.onerror = reject;
                    img.src = URL.createObjectURL(blob);
                });
                
                log(`å›¾ç‰‡åŠ è½½æˆåŠŸ: ${img.width}Ã—${img.height}`, 'info');
                
                // 3. è®¡ç®—è£å‰ªå‚æ•°
                const cropParams = calculateSmartCrop(
                    img.width, img.height,
                    config.target[0], config.target[1]
                );
                
                log(`è£å‰ªå‚æ•°: (${cropParams.x},${cropParams.y}) ${cropParams.width}Ã—${cropParams.height}`, 'info');
                
                // 4. æ‰§è¡ŒCanvasè£å‰ª
                const canvas = document.createElement('canvas');
                canvas.width = config.target[0];
                canvas.height = config.target[1];
                const ctx = canvas.getContext('2d');
                
                // æ¸…ç©ºCanvas
                ctx.fillStyle = '#FFFFFF';
                ctx.fillRect(0, 0, canvas.width, canvas.height);
                
                // æ‰§è¡Œè£å‰ª
                ctx.drawImage(
                    img,
                    cropParams.x, cropParams.y, cropParams.width, cropParams.height,
                    0, 0, config.target[0], config.target[1]
                );
                
                // 5. ç”Ÿæˆç»“æœ
                const croppedDataURL = canvas.toDataURL('image/jpeg', 0.9);
                const croppedBlob = await new Promise(resolve => {
                    canvas.toBlob(resolve, 'image/jpeg', 0.9);
                });
                
                // 6. ç”Ÿæˆæ–‡ä»¶å
                const sceneMap = {
                    'instagram-post': 'ig_post',
                    'instagram-story': 'ig_story',
                    'tiktok': 'tiktok',
                    'linkedin-avatar': 'linkedin',
                    'wechat-avatar': 'wechat',
                    'youtube-thumbnail': 'youtube',
                    'facebook-cover': 'facebook',
                    'twitter-avatar': 'twitter'
                };
                
                const outputFilename = `${index + 1}_${sceneMap[config.scene] || config.scene}_${config.target[0]}x${config.target[1]}.jpg`;
                
                // 7. ä¿å­˜ç»“æœ
                const result = {
                    index: index + 1,
                    originalFile: config.file,
                    scene: config.scene,
                    targetSize: config.target,
                    cropParams,
                    outputFilename,
                    dataURL: croppedDataURL,
                    blob: croppedBlob,
                    canvas: canvas.cloneNode(),
                    originalSize: [img.width, img.height]
                };
                
                processedResults[index] = result;
                log(`âœ… å›¾ç‰‡ ${index + 1} å¤„ç†å®Œæˆ: ${outputFilename}`, 'success');
                
                // 8. æ˜¾ç¤ºé¢„è§ˆ
                displayResult(result);
                
                // æ¸…ç†å†…å­˜
                URL.revokeObjectURL(img.src);
                
                return result;
                
            } catch (error) {
                log(`âŒ å›¾ç‰‡ ${index + 1} å¤„ç†å¤±è´¥: ${error.message}`, 'error');
                throw error;
            }
        }

        // æ˜¾ç¤ºå¤„ç†ç»“æœ
        function displayResult(result) {
            const grid = document.getElementById('results-grid');
            
            const item = document.createElement('div');
            item.className = 'crop-item';
            item.innerHTML = `
                <div class="crop-preview">
                    <canvas class="preview-canvas" width="80" height="80"></canvas>
                    <div class="crop-info">
                        <strong>${result.index}. ${result.scene}</strong><br>
                        <small>åŸå›¾: ${result.originalSize[0]}Ã—${result.originalSize[1]}</small><br>
                        <small>è¾“å‡º: ${result.targetSize[0]}Ã—${result.targetSize[1]}</small><br>
                        <small>${result.outputFilename}</small><br>
                        <span class="status-badge status-success">å¤„ç†å®Œæˆ</span>
                    </div>
                </div>
            `;
            
            grid.appendChild(item);
            
            // ç»˜åˆ¶é¢„è§ˆ
            const previewCanvas = item.querySelector('.preview-canvas');
            const previewCtx = previewCanvas.getContext('2d');
            
            // è®¡ç®—é¢„è§ˆå°ºå¯¸
            const maxSize = 80;
            const scale = Math.min(maxSize / result.targetSize[0], maxSize / result.targetSize[1]);
            const previewWidth = result.targetSize[0] * scale;
            const previewHeight = result.targetSize[1] * scale;
            
            previewCanvas.width = previewWidth;
            previewCanvas.height = previewHeight;
            previewCtx.drawImage(result.canvas, 0, 0, previewWidth, previewHeight);
        }

        // å¼€å§‹æ‰¹é‡å¤„ç†
        async function startBatchProcessing() {
            const startBtn = document.getElementById('start-btn');
            const downloadBtn = document.getElementById('download-btn');
            
            startBtn.disabled = true;
            processedResults = [];
            currentProcessing = 0;
            
            document.getElementById('results-grid').innerHTML = '';
            
            log('ğŸš€ å¼€å§‹æ‰¹é‡Canvasè£å‰ªå¤„ç†...', 'processing');
            log(`ğŸ“Š æ€»è®¡ ${imageConfigs.length} å¼ å›¾ç‰‡å¾…å¤„ç†`, 'info');
            
            const startTime = Date.now();
            
            try {
                for (let i = 0; i < imageConfigs.length; i++) {
                    currentProcessing = i + 1;
                    updateProgress(currentProcessing, imageConfigs.length);
                    
                    await processSingleImage(imageConfigs[i], i);
                    
                    // çŸ­æš‚å»¶è¿Ÿé¿å…æµè§ˆå™¨å¡é¡¿
                    if (i < imageConfigs.length - 1) {
                        await new Promise(resolve => setTimeout(resolve, 200));
                    }
                }
                
                const endTime = Date.now();
                const duration = ((endTime - startTime) / 1000).toFixed(1);
                
                log(`ğŸ‰ æ‰¹é‡å¤„ç†å®Œæˆ! è€—æ—¶: ${duration}ç§’`, 'success');
                log(`ğŸ“Š æˆåŠŸå¤„ç†: ${processedResults.filter(r => r).length}/${imageConfigs.length} å¼ å›¾ç‰‡`, 'success');
                
                downloadBtn.disabled = false;
                generateProcessingReport();
                
            } catch (error) {
                log(`âŒ æ‰¹é‡å¤„ç†å¼‚å¸¸: ${error.message}`, 'error');
            } finally {
                startBtn.disabled = false;
                updateProgress(imageConfigs.length, imageConfigs.length);
            }
        }

        // ç”Ÿæˆå¤„ç†æŠ¥å‘Š
        function generateProcessingReport() {
            const successful = processedResults.filter(r => r).length;
            const failed = imageConfigs.length - successful;
            
            log('ğŸ“‹ å¤„ç†æŠ¥å‘Š:', 'info');
            log(`âœ… æˆåŠŸ: ${successful} å¼ `, 'success');
            log(`âŒ å¤±è´¥: ${failed} å¼ `, failed > 0 ? 'error' : 'info');
            log(`ğŸ“ è¾“å‡ºæ ¼å¼åˆ†å¸ƒ:`, 'info');
            
            const formatCount = {};
            processedResults.forEach(result => {
                if (result) {
                    const format = `${result.targetSize[0]}Ã—${result.targetSize[1]}`;
                    formatCount[format] = (formatCount[format] || 0) + 1;
                }
            });
            
            Object.entries(formatCount).forEach(([format, count]) => {
                log(`   â€¢ ${format}: ${count} å¼ `, 'info');
            });
        }

        // æ‰¹é‡ä¸‹è½½ç»“æœ
        async function downloadAllResults() {
            log('ğŸ“¦ å¼€å§‹æ‰¹é‡ä¸‹è½½è£å‰ªç»“æœ...', 'processing');
            
            const validResults = processedResults.filter(r => r);
            
            for (let i = 0; i < validResults.length; i++) {
                const result = validResults[i];
                
                try {
                    const link = document.createElement('a');
                    link.download = result.outputFilename;
                    link.href = result.dataURL;
                    link.style.display = 'none';
                    
                    document.body.appendChild(link);
                    link.click();
                    document.body.removeChild(link);
                    
                    log(`ğŸ“¥ ä¸‹è½½: ${result.outputFilename}`, 'info');
                    
                    // å»¶è¿Ÿé¿å…æµè§ˆå™¨é™åˆ¶
                    if (i < validResults.length - 1) {
                        await new Promise(resolve => setTimeout(resolve, 300));
                    }
                    
                } catch (error) {
                    log(`âŒ ä¸‹è½½å¤±è´¥: ${result.outputFilename} - ${error.message}`, 'error');
                }
            }
            
            log(`âœ… æ‰¹é‡ä¸‹è½½å®Œæˆ! å…± ${validResults.length} ä¸ªæ–‡ä»¶`, 'success');
            log('ğŸ—‚ï¸ è¯·å°†ä¸‹è½½çš„æ–‡ä»¶æ•´ç†åˆ° test_results/cropped_results_v1.0_canvas/ æ–‡ä»¶å¤¹', 'info');
        }

        // é¡µé¢åŠ è½½å®Œæˆ
        window.onload = function() {
            log('ğŸ¨ Canvasæ‰¹é‡è£å‰ªå¤„ç†å™¨å·²åŠ è½½', 'info');
            log('ğŸ“ æ£€æµ‹åˆ°20å¼ çœŸå®å›¾ç‰‡é…ç½®', 'info');
            log('ğŸ¯ å·²åˆ†é…8ç§ä¸åŒçš„ä½¿ç”¨åœºæ™¯', 'info');
            log('âš¡ å‡†å¤‡å¼€å§‹Canvasè£å‰ªå¤„ç†...', 'info');
        };
    </script>
</body>
</html>