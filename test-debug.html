<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AIå›¾ç‰‡è£å‰ªå·¥å…· - è°ƒè¯•æµ‹è¯•</title>
    <style>
        body { 
            font-family: Arial, sans-serif; 
            margin: 20px;
            background: #f5f5f5;
        }
        .test-section {
            background: white;
            padding: 20px;
            margin-bottom: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .test-button {
            background: #007bff;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            margin: 5px;
        }
        .test-button:hover { background: #0056b3; }
        .success { color: #28a745; }
        .error { color: #dc3545; }
        .warning { color: #ffc107; }
        .info { color: #17a2b8; }
        
        #test-canvas {
            border: 1px solid #ddd;
            max-width: 100%;
            margin: 10px 0;
        }
        
        .log {
            background: #f8f9fa;
            border: 1px solid #e9ecef;
            padding: 10px;
            margin: 10px 0;
            border-radius: 4px;
            max-height: 200px;
            overflow-y: auto;
            font-family: monospace;
            font-size: 12px;
        }
        
        .file-input {
            margin: 10px 0;
        }
    </style>
</head>
<body>
    <h1>ğŸ§ª AIå›¾ç‰‡è£å‰ªå·¥å…· - è°ƒè¯•æµ‹è¯•é¡µé¢</h1>
    
    <div class="test-section">
        <h2>ğŸ“‹ ç³»ç»Ÿæ£€æŸ¥</h2>
        <button class="test-button" onclick="runSystemCheck()">è¿è¡Œç³»ç»Ÿæ£€æŸ¥</button>
        <div id="system-check-log" class="log"></div>
    </div>

    <div class="test-section">
        <h2>ğŸ—‚ï¸ å¹³å°è§„æ ¼æ•°æ®åº“æµ‹è¯•</h2>
        <button class="test-button" onclick="testPlatformSpecs()">æµ‹è¯•å¹³å°è§„æ ¼</button>
        <div id="platform-specs-log" class="log"></div>
    </div>

    <div class="test-section">
        <h2>ğŸ–¼ï¸ å›¾åƒå¤„ç†æµ‹è¯•</h2>
        <div class="file-input">
            <label>é€‰æ‹©æµ‹è¯•å›¾ç‰‡: </label>
            <input type="file" id="test-image-input" accept="image/*">
        </div>
        <button class="test-button" onclick="testImageOptimization()">æµ‹è¯•å›¾åƒä¼˜åŒ–</button>
        <button class="test-button" onclick="testCanvasCropping()">æµ‹è¯•Canvasè£å‰ª</button>
        <canvas id="test-canvas" width="300" height="300"></canvas>
        <div id="image-test-log" class="log"></div>
    </div>

    <div class="test-section">
        <h2>ğŸ¤– GPT-4.1 APIæµ‹è¯•</h2>
        <div class="file-input">
            <label>é€‰æ‹©æµ‹è¯•å›¾ç‰‡: </label>
            <input type="file" id="gpt-test-image" accept="image/*">
        </div>
        <select id="test-scene">
            <option value="instagram-post">Instagramå¸–å­</option>
            <option value="instagram-story">Instagramæ•…äº‹</option>
            <option value="tiktok">TikTokè§†é¢‘</option>
        </select>
        <button class="test-button" onclick="testGPTAPI()">æµ‹è¯•GPT-4.1åˆ†æ</button>
        <div id="gpt-test-log" class="log"></div>
    </div>

    <div class="test-section">
        <h2>ğŸ”„ å®Œæ•´å·¥ä½œæµç¨‹æµ‹è¯•</h2>
        <div class="file-input">
            <label>é€‰æ‹©æµ‹è¯•å›¾ç‰‡: </label>
            <input type="file" id="workflow-test-image" accept="image/*">
        </div>
        <select id="workflow-scene">
            <option value="instagram-post">Instagramå¸–å­ (1:1)</option>
            <option value="instagram-story">Instagramæ•…äº‹ (9:16)</option>
            <option value="tiktok">TikTokè§†é¢‘ (9:16)</option>
            <option value="linkedin-avatar">LinkedInå¤´åƒ (1:1)</option>
        </select>
        <button class="test-button" onclick="testCompleteWorkflow()">æµ‹è¯•å®Œæ•´æµç¨‹</button>
        <canvas id="workflow-canvas" width="400" height="400"></canvas>
        <div id="workflow-log" class="log"></div>
        <div id="workflow-result"></div>
    </div>

    <!-- åŠ è½½æ ¸å¿ƒæ¨¡å— -->
    <script src="js/platform-specs.js"></script>
    <script src="js/gpt4-vision-api.js"></script>
    <script src="js/image-cropper.js"></script>

    <script>
        let testAPI = null;
        let testCropEngine = null;

        // ç³»ç»Ÿæ£€æŸ¥
        function runSystemCheck() {
            const log = document.getElementById('system-check-log');
            log.innerHTML = '';
            
            function addLog(message, type = 'info') {
                log.innerHTML += `<div class="${type}">[${new Date().toLocaleTimeString()}] ${message}</div>`;
            }

            addLog('ğŸ” å¼€å§‹ç³»ç»Ÿæ£€æŸ¥...');

            // æ£€æŸ¥æ ¸å¿ƒç±»æ˜¯å¦åŠ è½½
            try {
                if (typeof PLATFORM_SPECS !== 'undefined') {
                    addLog('âœ… å¹³å°è§„æ ¼æ•°æ®åº“å·²åŠ è½½', 'success');
                    addLog(`   æ”¯æŒ ${Object.keys(PLATFORM_SPECS).length} ä¸ªåœºæ™¯`, 'info');
                } else {
                    addLog('âŒ å¹³å°è§„æ ¼æ•°æ®åº“æœªåŠ è½½', 'error');
                }

                if (typeof GPT4VisionAPI !== 'undefined') {
                    addLog('âœ… GPT-4.1 Vision APIç±»å·²åŠ è½½', 'success');
                    testAPI = new GPT4VisionAPI();
                    addLog(`   APIåœ°å€: ${testAPI.apiBase}`, 'info');
                } else {
                    addLog('âŒ GPT-4.1 Vision APIç±»æœªåŠ è½½', 'error');
                }

                if (typeof ImageCropEngine !== 'undefined') {
                    addLog('âœ… å›¾åƒè£å‰ªå¼•æ“å·²åŠ è½½', 'success');
                } else {
                    addLog('âŒ å›¾åƒè£å‰ªå¼•æ“æœªåŠ è½½', 'error');
                }

                // æ£€æŸ¥æµè§ˆå™¨APIæ”¯æŒ
                if (typeof FileReader !== 'undefined') {
                    addLog('âœ… FileReader APIæ”¯æŒ', 'success');
                } else {
                    addLog('âŒ FileReader APIä¸æ”¯æŒ', 'error');
                }

                if (typeof HTMLCanvasElement !== 'undefined') {
                    addLog('âœ… Canvas APIæ”¯æŒ', 'success');
                } else {
                    addLog('âŒ Canvas APIä¸æ”¯æŒ', 'error');
                }

                addLog('ğŸ‰ ç³»ç»Ÿæ£€æŸ¥å®Œæˆ', 'success');

            } catch (error) {
                addLog(`âŒ ç³»ç»Ÿæ£€æŸ¥å¤±è´¥: ${error.message}`, 'error');
            }
        }

        // æµ‹è¯•å¹³å°è§„æ ¼
        function testPlatformSpecs() {
            const log = document.getElementById('platform-specs-log');
            log.innerHTML = '';
            
            function addLog(message, type = 'info') {
                log.innerHTML += `<div class="${type}">[${new Date().toLocaleTimeString()}] ${message}</div>`;
            }

            try {
                addLog('ğŸ§ª æµ‹è¯•å¹³å°è§„æ ¼æ•°æ®åº“...');

                // æµ‹è¯•åŸºç¡€åŠŸèƒ½
                const instagramSpecs = getSpecsByScene('instagram-post');
                if (instagramSpecs) {
                    addLog('âœ… Instagramè§„æ ¼è·å–æˆåŠŸ', 'success');
                    addLog(`   æ¯”ä¾‹: ${instagramSpecs.ratio}, æ¨èå°ºå¯¸: ${instagramSpecs.recommended_size.join('Ã—')}`, 'info');
                } else {
                    addLog('âŒ Instagramè§„æ ¼è·å–å¤±è´¥', 'error');
                }

                // æµ‹è¯•æ¯”ä¾‹è§£æ
                const ratio = parseRatio('16:9');
                addLog(`âœ… æ¯”ä¾‹è§£ææµ‹è¯•: 16:9 = ${ratio.toFixed(3)}`, 'success');

                // æµ‹è¯•æ ¼å¼éªŒè¯
                const validation = validateOutputSize([1080, 1080], 'instagram-post');
                if (validation.valid) {
                    addLog('âœ… æ ¼å¼éªŒè¯æµ‹è¯•é€šè¿‡', 'success');
                    addLog(`   å‡†ç¡®åº¦: ${validation.format_accuracy}`, 'info');
                } else {
                    addLog(`âŒ æ ¼å¼éªŒè¯å¤±è´¥: ${validation.error}`, 'error');
                }

                // æµ‹è¯•åœºæ™¯åˆ†ç±»
                const socialScenes = getScenesByCategory('social');
                addLog(`âœ… ç¤¾äº¤åª’ä½“åœºæ™¯: ${socialScenes.length}ä¸ª`, 'success');

                addLog('ğŸ‰ å¹³å°è§„æ ¼æµ‹è¯•å®Œæˆ', 'success');

            } catch (error) {
                addLog(`âŒ å¹³å°è§„æ ¼æµ‹è¯•å¤±è´¥: ${error.message}`, 'error');
            }
        }

        // æµ‹è¯•å›¾åƒä¼˜åŒ–
        async function testImageOptimization() {
            const log = document.getElementById('image-test-log');
            const fileInput = document.getElementById('test-image-input');
            
            function addLog(message, type = 'info') {
                log.innerHTML += `<div class="${type}">[${new Date().toLocaleTimeString()}] ${message}</div>`;
            }

            if (!fileInput.files[0]) {
                addLog('âŒ è¯·å…ˆé€‰æ‹©æµ‹è¯•å›¾ç‰‡', 'error');
                return;
            }

            try {
                if (!testAPI) testAPI = new GPT4VisionAPI();

                addLog('ğŸ”§ å¼€å§‹å›¾åƒä¼˜åŒ–æµ‹è¯•...');
                
                const file = fileInput.files[0];
                addLog(`ğŸ“ åŸå§‹å›¾ç‰‡: ${file.name}, å¤§å°: ${(file.size/1024/1024).toFixed(2)}MB`, 'info');

                const optimizedImage = await testAPI.optimizeImageForAPI(file);
                
                // è®¡ç®—å‹ç¼©åçš„å¤§å°
                const base64Length = optimizedImage.length;
                const compressedSize = (base64Length * 0.75) / 1024 / 1024; // å¤§çº¦çš„å­—èŠ‚å¤§å°
                
                addLog(`âœ… å›¾åƒä¼˜åŒ–å®Œæˆ`, 'success');
                addLog(`   å‹ç¼©åå¤§å°: ~${compressedSize.toFixed(2)}MB`, 'info');
                addLog(`   å‹ç¼©æ¯”ä¾‹: ${((file.size/1024/1024)/compressedSize).toFixed(1)}:1`, 'info');

            } catch (error) {
                addLog(`âŒ å›¾åƒä¼˜åŒ–å¤±è´¥: ${error.message}`, 'error');
            }
        }

        // æµ‹è¯•Canvasè£å‰ª
        async function testCanvasCropping() {
            const log = document.getElementById('image-test-log');
            const fileInput = document.getElementById('test-image-input');
            const canvas = document.getElementById('test-canvas');
            
            function addLog(message, type = 'info') {
                log.innerHTML += `<div class="${type}">[${new Date().toLocaleTimeString()}] ${message}</div>`;
            }

            if (!fileInput.files[0]) {
                addLog('âŒ è¯·å…ˆé€‰æ‹©æµ‹è¯•å›¾ç‰‡', 'error');
                return;
            }

            try {
                addLog('âœ‚ï¸ å¼€å§‹Canvasè£å‰ªæµ‹è¯•...');

                testCropEngine = new ImageCropEngine(canvas);
                await testCropEngine.loadImage(fileInput.files[0]);

                // æ¨¡æ‹Ÿè£å‰ªå‚æ•°ï¼ˆå±…ä¸­æ­£æ–¹å½¢è£å‰ªï¼‰
                const mockCropSolution = {
                    reason: "æµ‹è¯•æ­£æ–¹å½¢è£å‰ª\\næ•ˆæœï¼šå±…ä¸­è£å‰ªä¸ºæ­£æ–¹å½¢ï¼Œç”¨äºæµ‹è¯•CanvasåŠŸèƒ½ã€‚",
                    details: "æµ‹è¯•è£å‰ªå‚æ•°ï¼š\\n\\nç›®æ ‡æ¯”ä¾‹ï¼š1:1\\nè£åˆ‡æ–¹å¼ï¼šå±…ä¸­è£å‰ª\\nå¯¼å‡ºå°ºå¯¸ï¼š300Ã—300",
                    crop_params: {
                        original_size: [testCropEngine.originalImage.width, testCropEngine.originalImage.height],
                        crop_box: {
                            x: 0,
                            y: 0,
                            width: Math.min(testCropEngine.originalImage.width, testCropEngine.originalImage.height),
                            height: Math.min(testCropEngine.originalImage.width, testCropEngine.originalImage.height)
                        },
                        output_size: [300, 300],
                        crop_ratio: "1:1"
                    }
                };

                const result = await testCropEngine.executeCropFromJSON(mockCropSolution, 'square');

                addLog('âœ… Canvasè£å‰ªæµ‹è¯•å®Œæˆ', 'success');
                addLog(`   è¾“å‡ºå°ºå¯¸: ${result.croppedImage.size.width}Ã—${result.croppedImage.size.height}`, 'info');
                addLog(`   æ ¼å¼éªŒè¯: ${result.validation.valid ? 'é€šè¿‡' : 'å¤±è´¥'}`, result.validation.valid ? 'success' : 'error');

            } catch (error) {
                addLog(`âŒ Canvasè£å‰ªæµ‹è¯•å¤±è´¥: ${error.message}`, 'error');
                console.error(error);
            }
        }

        // æµ‹è¯•GPT-4.1 API
        async function testGPTAPI() {
            const log = document.getElementById('gpt-test-log');
            const fileInput = document.getElementById('gpt-test-image');
            const sceneSelect = document.getElementById('test-scene');
            
            function addLog(message, type = 'info') {
                log.innerHTML += `<div class="${type}">[${new Date().toLocaleTimeString()}] ${message}</div>`;
            }

            if (!fileInput.files[0]) {
                addLog('âŒ è¯·å…ˆé€‰æ‹©æµ‹è¯•å›¾ç‰‡', 'error');
                return;
            }

            try {
                if (!testAPI) testAPI = new GPT4VisionAPI();

                const scene = sceneSelect.value;
                const specs = getSpecsByScene(scene);
                
                addLog(`ğŸ¤– å¼€å§‹GPT-4.1 APIæµ‹è¯•...`, 'info');
                addLog(`   åœºæ™¯: ${scene}`, 'info');
                addLog(`   è§„æ ¼: ${specs.ratio}, ${specs.recommended_size.join('Ã—')}`, 'info');

                // ä¼˜åŒ–å›¾ç‰‡
                addLog('ğŸ”§ ä¼˜åŒ–å›¾ç‰‡ä¸­...', 'info');
                const optimizedImage = await testAPI.optimizeImageForAPI(fileInput.files[0]);
                
                // è°ƒç”¨GPT API
                addLog('ğŸ“¡ è°ƒç”¨GPT-4.1 Vision API...', 'info');
                addLog('â³ è¯·ç¨ç­‰ï¼ŒGPT-4.1æ­£åœ¨åˆ†æå›¾ç‰‡...', 'warning');
                
                const cropSolution = await testAPI.analyzeCropSolution(scene, specs, optimizedImage);

                addLog('âœ… GPT-4.1åˆ†æå®Œæˆ!', 'success');
                addLog(`ğŸ“ è£å‰ªç†ç”±: ${cropSolution.reason.replace(/\\n/g, ' ')}`, 'info');
                addLog(`ğŸ“Š è£å‰ªå‚æ•°: ${JSON.stringify(cropSolution.crop_params, null, 2)}`, 'info');

            } catch (error) {
                addLog(`âŒ GPT-4.1 APIæµ‹è¯•å¤±è´¥: ${error.message}`, 'error');
                console.error('GPT API Error:', error);
            }
        }

        // æµ‹è¯•å®Œæ•´å·¥ä½œæµç¨‹
        async function testCompleteWorkflow() {
            const log = document.getElementById('workflow-log');
            const resultDiv = document.getElementById('workflow-result');
            const fileInput = document.getElementById('workflow-test-image');
            const sceneSelect = document.getElementById('workflow-scene');
            const canvas = document.getElementById('workflow-canvas');
            
            function addLog(message, type = 'info') {
                log.innerHTML += `<div class="${type}">[${new Date().toLocaleTimeString()}] ${message}</div>`;
            }

            if (!fileInput.files[0]) {
                addLog('âŒ è¯·å…ˆé€‰æ‹©æµ‹è¯•å›¾ç‰‡', 'error');
                return;
            }

            try {
                const scene = sceneSelect.value;
                const specs = getSpecsByScene(scene);
                
                addLog('ğŸš€ å¼€å§‹å®Œæ•´å·¥ä½œæµç¨‹æµ‹è¯•...', 'info');
                addLog(`   åœºæ™¯: ${specs.name}`, 'info');

                // 1. åˆå§‹åŒ–ç»„ä»¶
                if (!testAPI) testAPI = new GPT4VisionAPI();
                testCropEngine = new ImageCropEngine(canvas);

                // 2. å›¾åƒä¼˜åŒ–
                addLog('ğŸ”§ æ­¥éª¤1: ä¼˜åŒ–å›¾åƒ...', 'info');
                const optimizedImage = await testAPI.optimizeImageForAPI(fileInput.files[0]);

                // 3. GPT-4.1åˆ†æ
                addLog('ğŸ¤– æ­¥éª¤2: GPT-4.1åˆ†æ...', 'info');
                const cropSolution = await testAPI.analyzeCropSolution(scene, specs, optimizedImage);

                // 4. åŠ è½½åŸå›¾åˆ°è£å‰ªå¼•æ“
                addLog('ğŸ–¼ï¸ æ­¥éª¤3: åŠ è½½å›¾åƒåˆ°è£å‰ªå¼•æ“...', 'info');
                await testCropEngine.loadImage(fileInput.files[0]);

                // 5. æ‰§è¡Œè£å‰ª
                addLog('âœ‚ï¸ æ­¥éª¤4: æ‰§è¡Œè£å‰ª...', 'info');
                const cropResult = await testCropEngine.executeCropFromJSON(cropSolution, scene);

                // 6. æ˜¾ç¤ºç»“æœ
                addLog('ğŸ‰ å®Œæ•´å·¥ä½œæµç¨‹æµ‹è¯•æˆåŠŸ!', 'success');
                
                resultDiv.innerHTML = `
                    <h3>ğŸ“Š æµ‹è¯•ç»“æœ</h3>
                    <p><strong>è£å‰ªç†ç”±:</strong><br>${cropSolution.reason.replace(/\\n/g, '<br>')}</p>
                    <p><strong>æŠ€æœ¯è¯´æ˜:</strong><br>${cropSolution.details.replace(/\\n/g, '<br>')}</p>
                    <p><strong>æ ¼å¼éªŒè¯:</strong> ${cropResult.validation.valid ? 'âœ… é€šè¿‡' : 'âŒ å¤±è´¥'}</p>
                    <p><strong>è¾“å‡ºå°ºå¯¸:</strong> ${cropResult.cropParams.output_size.join('Ã—')}</p>
                    <button class="test-button" onclick="downloadTestResult()">ä¸‹è½½æµ‹è¯•ç»“æœ</button>
                `;

                // å­˜å‚¨ç»“æœä¾›ä¸‹è½½
                window.testResult = { cropEngine: testCropEngine, scene, cropParams: cropResult.cropParams };

            } catch (error) {
                addLog(`âŒ å®Œæ•´å·¥ä½œæµç¨‹æµ‹è¯•å¤±è´¥: ${error.message}`, 'error');
                console.error('Workflow Error:', error);
            }
        }

        // ä¸‹è½½æµ‹è¯•ç»“æœ
        async function downloadTestResult() {
            if (!window.testResult) {
                alert('æ²¡æœ‰å¯ä¸‹è½½çš„æµ‹è¯•ç»“æœ');
                return;
            }

            try {
                const { cropEngine, scene, cropParams } = window.testResult;
                const blob = await cropEngine.generateBlob('png', 1.0);
                const filename = `test-${scene}-${cropParams.output_size.join('x')}-${Date.now()}.png`;
                
                downloadCroppedImage(blob, filename);
                console.log('âœ… æµ‹è¯•ç»“æœä¸‹è½½å®Œæˆ');
                
            } catch (error) {
                console.error('âŒ ä¸‹è½½å¤±è´¥:', error);
                alert('ä¸‹è½½å¤±è´¥: ' + error.message);
            }
        }

        // é¡µé¢åŠ è½½å®Œæˆåè‡ªåŠ¨è¿è¡Œç³»ç»Ÿæ£€æŸ¥
        window.addEventListener('load', () => {
            setTimeout(runSystemCheck, 1000);
        });
    </script>
</body>
</html>