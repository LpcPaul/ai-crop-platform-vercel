# GPT-4.1 Vision Prompt版本管理

## 📋 当前版本信息

**当前版本**: v0.1  
**更新日期**: 2024-09-12  
**API模型**: gpt-4.1-preview  
**测试状态**: ✅ 已验证  

## 🎯 v0.1 完整Prompt内容

### 美学裁剪模式 (aesthetic)

```text
# 裁剪智能体 Prompt

你是专业的图片裁剪专家。坐标原点为左上角，单位为像素。**只允许裁切，不得生成或拉伸内容**。
**输入：** 原图尺寸 `(${originalWidth}×${originalHeight})`。
**目标：** 让图片更美观、更有视觉冲击力。

---

## 硬性约束（防越界/无效）

* `x ∈ [0, ${originalWidth-100}]`，`y ∈ [0, ${originalHeight-100}]`
* `width ≥ 100`，`height ≥ 100`
* 必须满足：`x + width ≤ ${originalWidth}` 且 `y + height ≤ ${originalHeight}`

---

## 审美激活（模型内部自评，用于选择最终裁剪；最终只输出 JSON）

1. **主体与叙事：** 识别画面叙事核心，确保裁后主体视觉层级最清晰，以张力为准。
2. **负空间与气氛：** 根据情绪合理留白，保证纹理/雾层连续自然。
3. **视线流与平衡：** 优化引导线与明暗权重，避免边缘高亮/碎物体分散注意。
4. **干扰剔除：** 优先裁掉突兀亮点、重复纹理、贴边碰撞等；避免"截肢式"裁切。
5. **构图稳定：** 地平/垂直更稳定；若保留倾斜，需服务叙事。
6. **比例自选：** 自由选择最服务叙事的比例（如宽银幕/方形/竖幅），而非机械套模板。

---

## 只返回以下 JSON（严格键名，勿添加多余文本）

{
  "analysis": {
    "方案标题": "简洁的方案名称",
    "效果": "具体的视觉效果描述"
  },
  "crop_params": {
    "x": 0,
    "y": 0,
    "width": 100,
    "height": 100
  },
  "subject_anchor_hint": {
    "x_norm": 0.50,
    "y_norm": 0.50
  }
}

### 字段说明

* **analysis.方案标题：** 给该裁剪一个简洁、直观的名字（如"电影宽银幕"）。
* **analysis.效果：** 描述裁剪后的视觉效果与叙事（如"强调孤独与辽阔，去除右侧亮点干扰"）。
* **crop\_params：** 裁剪框的起点与尺寸，像素单位，必须完全落在原图范围内。
* **subject\_anchor\_hint：** 主体锚点（归一化坐标，范围 `[0,1]`），以裁后画面左上角为原点。

> 最终仅输出上述 JSON；若内部质检不通过（审美或坐标越界），请自行调整后再输出一次最终 JSON。
```

### API调用配置

```javascript
{
  "endpoint": "https://api.apiyi.com/v1/chat/completions",
  "model": "gpt-4.1-preview",
  "max_tokens": 800,
  "temperature": 0.3,
  "retry_attempts": 2,
  "validation": "enabled"
}
```

## 🔧 v0.1 核心特性

### 新增字段: subject_anchor_hint
```json
{
  "subject_anchor_hint": {
    "x_norm": 0.50,  // 主体横向位置 (0=最左, 1=最右)
    "y_norm": 0.50   // 主体纵向位置 (0=最上, 1=最下)
  }
}
```

**用途**:
- 前端/服务端二次对齐（如吸附三分线）
- 多比例复用与质量校验
- 代表视觉核心位置（人物面部/胸口、产品中心、建筑消失点等）

### 参数验证机制
1. **类型检查**: 确保所有坐标为整数
2. **边界验证**: 防止越界和最小尺寸限制
3. **智能修正**: 自动修正异常参数
4. **二次请求**: 参数错误时自动重试
5. **备用算法**: API失败时提供高质量后备方案

## 📈 版本历史

### v0.1 (2024-09-12) - 当前版本
**主要变更**:
- ✅ **新增subject_anchor_hint字段** - 主体锚点归一化坐标
- ✅ **硬性约束明确化** - 精确的数学边界定义
- ✅ **审美激活6原则** - 专业摄影美学指导
- ✅ **参数验证系统** - 防越界/类型错误/奇怪值
- ✅ **二次请求机制** - 参数有问题时自动重试
- ✅ **完善的备用算法** - 包含主体锚点的3种构图方案
- ✅ **prompt文件化管理** - 从外部文件加载prompt模板

**技术增强**:
- 严格JSON格式要求，避免多余文本
- 详细的字段说明和使用示例
- 从简单case改为完整的审美理论指导
- 增强的错误处理和日志记录

**测试结果**:
- API状态: 503错误（服务暂时不可用）
- 备用算法: ✅ 完美工作，包含subject_anchor_hint
- 参数验证: ✅ 所有验证逻辑正常
- 二次请求: ✅ 重试机制正常工作

### v2.1 (2024-09-12) - 已废弃
**问题**:
- 缺少subject_anchor_hint字段
- 参数验证不够完善
- prompt约束过于简单

## 🧪 测试验证

### 当前测试结果
```bash
curl -X POST -F "image=@test.jpg" http://localhost:3001/api/crop/aesthetic
```

### 实际返回格式（备用算法）
```json
{
  "success": true,
  "analysis": {
    "方案标题": "黄金比例构图",
    "效果": "营造和谐视觉节奏，提升整体美感和艺术性"
  },
  "crop_params": {
    "x": 162, "y": 135,
    "width": 756, "height": 1080
  },
  "subject_anchor_hint": {
    "x_norm": 0.618,
    "y_norm": 0.382
  },
  "validation_info": {
    "fallback_used": true,
    "attempt_count": 0
  }
}
```

## 📋 下次修改检查清单

- [ ] 更新版本号到v0.2
- [ ] 记录修改原因和目标
- [ ] 测试GPT API调用
- [ ] 验证subject_anchor_hint准确性
- [ ] 验证参数验证逻辑
- [ ] 更新prompt文件
- [ ] 提交到Git

## 🎯 v0.1 设计哲学

### 核心理念
1. **硬性约束优先** - 数学边界确保程序稳定性
2. **审美理论指导** - 6大原则替代简单case
3. **结构化输出** - 严格JSON格式，便于解析
4. **智能容错** - 多层验证和自动修正
5. **可视化支持** - 主体锚点为前端提供对齐基准

### 优化效果
- **可靠性提升**: 参数验证防止程序崩溃
- **美学水平提升**: 专业摄影理论指导
- **可扩展性增强**: 主体锚点支持更多功能
- **调试便利性**: 详细的验证信息和日志

---

**文档版本**: v0.1  
**维护者**: AI Crop Service Team  
**最后更新**: 2024-09-12 17:00